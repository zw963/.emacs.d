#+OPTIONS: timestamp:nil \n:t num:nil ellit-cid:t
#+TITLE: Telega Manual (v0.7.15)
#+AUTHOR: Zajcev Evgeny
#+startup: showall

#+macro: nl          (eval (concat "\n" (make-string (1- (string-to-number $1)) ?\s)))
#+macro: user-option User Option: ~$1~ {{{nl(1)}}} {{{nl($2)}}} {{{vardoc($1, $2)}}} {{{nl(1)}}} {{{nl($2)}}} Default value: {{{eval((ellit-org-pp-code-block $1 $2), t)}}}
#+macro: user-option1 User Option: ~$1~ {{{nl(1)}}} {{{nl($2)}}} {{{vardoc1($1, $2)}}} {{{nl(1)}}} {{{nl($2)}}} Default value: {{{eval((ellit-org-pp-code-block $1 $2), t)}}}

#+begin_quote
This version of the manual for bleeding edge =telega= from "master"
branch running under bleeding edge TDLib from "master" branch. For
release version of the manual switch to [[https://zevlg.github.io/telega.el/index.html][Telega Manual]].

This file is automatically generated from =telega-ellit.org= by
[[https://github.com/zevlg/ellit-org.el][GitHub#ellit-org.el]] tool.
Do not edit manually.  Modify =telega-ellit.org= or comments in
=.el= files instead.
#+end_quote

* Contents                                                     :nohtmlexport:
:PROPERTIES:
:CUSTOM_ID: contents
:END:

  - [[#introduction][Introduction]]
  - [[#installation][Installation]]
    - [[#dependencies][Dependencies]]
    - [[#macos-users][MacOS users]]
    - [[#linux-users][Linux users]]
    - [[#building-tdlib][Building TDLib]]
    - [[#installing-telega-and-tdlib-from-gnu-guix][Installing telega and TDLib from GNU Guix]]
    - [[#installing-telega-from-melpa][Installing telega from MELPA]]
    - [[#installing-telega-directly-from-github][Installing telega directly from GitHub]]
  - [[#getting-started][Getting started]]
  - [[#settings-for-emacs-as-daemon][Settings for Emacs As Daemon]]
  - [[#telega-glossary][Telega glossary]]
  - [[#telega-prefix-map][Telega prefix map]]
  - [[#root-buffer][Root Buffer]]
    - [[#rootbuf-fast-navigation][Rootbuf fast navigation]]
    - [[#rootbuf-view-switching][Rootbuf view switching]]
  - [[#chat-folders][Chat Folders]]
  - [[#chat-filters][Chat Filters]]
    - [[#list-of-chat-filters][List of chat filters]]
    - [[#customizable-options-making-use-of-chat-filters][Customizable options making use of Chat Filters]]
  - [[#sorting-chats][Sorting chats]]
    - [[#sorting-criteria][Sorting criteria]]
    - [[#customizable-options-making-use-of-sorting-criteria][Customizable options making use of sorting criteria]]
  - [[#chat-buffer][Chat buffer]]
    - [[#chatbuf-fast-navigation][Chatbuf fast navigation]]
    - [[#sending-ordinary-messages][Sending ordinary messages]]
    - [[#attaching-media][Attaching media]]
    - [[#replying-and-editing-messages][Replying and editing messages]]
    - [[#forwarding-messages][Forwarding messages]]
    - [[#deleting-messages][Deleting messages]]
    - [[#scheduling-messages-and-reminders][Scheduling messages and reminders]]
    - [[#navigating-previous-input][Navigating previous input]]
    - [[#completing-input-in-chatbuf][Completing input in chatbuf]]
    - [[#sending-messages-via-bots][Sending messages via bots]]
    - [[#filtering-chat-messages-aka-shared-media][Filtering chat messages a.k.a. Shared Media]]
    - [[#opening-files-using-external-programs][Opening files using external programs]]
    - [[#client-side-messages-ignoring][Client side messages ignoring]]
  - [[#multiple-accounts][Multiple accounts]]
  - [[#minor-modes][Minor Modes]]
    - [[#notifications-for-incoming-messages][Notifications for incoming messages]]
    - [[#telega-mode-line-mode][telega-mode-line-mode]]
    - [[#telega-appindicator-mode][telega-appindicator-mode]]
    - [[#telega-squash-message-mode][telega-squash-message-mode]]
    - [[#telega-image-mode][telega-image-mode]]
    - [[#telega-edit-file-mode][telega-edit-file-mode]]
    - [[#telega-highlight-text-mode][telega-highlight-text-mode]]
    - [[#telega-patrons-mode][telega-patrons-mode]]
  - [[#contributed-packages][Contributed packages]]
    - [[#ol-telegael--org-mode-links-to-telegram-chats-and-messages][/ol-telega.el/ -- Org mode links to telegram chats and messages]]
    - [[#telega-status-historyel--global-minore-mode-to-save-users-online-status-history][/telega-status-history.el/ -- Global minore mode to save user's online status history]]
    - [[#telega-url-shortenel--makes-urls-look-nicer][/telega-url-shorten.el/ -- Makes urls look nicer]]
    - [[#telega-alertel--notifications-using-alertel][/telega-alert.el/ -- Notifications using =alert.el=]]
    - [[#telega-dired-dwimel--attach-files-from-dired-in-dwim-style][/telega-dired-dwim.el/ -- Attach files from dired in DWIM style]]
    - [[#telega-live-locationel--manage-live-location-in-telega-using-geoel][/telega-live-location.el/ -- Manage live location in Telega using geo.el]]
    - [[#telega-mnzel--display-emacs-content-inside-telega-messages][/telega-mnz.el/ -- Display Emacs content inside Telega messages.]]
    - [[#telega-dashboardel--important-telega-chats-in-the-emacs-dashboard][/telega-dashboard.el/ -- Important telega chats in the Emacs dashboard]]
    - [[#telega-storiesel--display-emacs-stories-in-the-dashboard][/telega-stories.el/ -- Display Emacs Stories in the dashboard]]

* Introduction
:PROPERTIES:
:CUSTOM_ID: introduction
:END:

=telega= is full featured unofficial client for [[https://telegram.org][Telegram]] platform for [[https://www.gnu.org/software/emacs/][GNU Emacs]].

=telega= is actively developed, for this reason, some features are not
implemented, or they are present just as skeleton for future
implementation. However, the core parts are mature enough so that it
is possible to use =telega= on daily basis.

Join us at [[https://t.me/emacs_telega]]

If you enjoy =telega=, consider making a [[https://opencollective.com/telega][donation for unstoppable
development]], also see benefits you get [[#telega-patrons-mode][being telega patron]].

* Installation
:PROPERTIES:
:CUSTOM_ID: installation
:END:

=telega= depends on the =visual-fill-column= and =rainbow-identifiers=
packages.  This dependency automatically installs if you install
=telega= from MELPA or GNU Guix.  Otherwise will you need to install
these packages by hand.

=telega= is built on top of the official library provided by Telegram
[[https://core.telegram.org/tdlib][TDLib]].  Most distributions do not provide this package in their
repositories, in which case you will have to install it manually by
following the instructions.

[[https://guix.gnu.org/][GNU Guix]], however, does have both =telega= and =TDLib= packaged.  If
you use GNU Guix you can skip directly to [[#installing-telega-and-tdlib-from-gnu-guix][Installing from GNU Guix]].

** Dependencies
:PROPERTIES:
:CUSTOM_ID: dependencies
:END:

- =GNU Emacs= (at least 26.1 is required with svg support)
- =GNU make= (known as gmake on BSD platforms)
- =GNU gperf= (for building TDLib)
- =CMake= (for building TDLib)
- =Python= (for testing the telega-server)
- =GNU Guix= _(optional, if using the Guix installation method)_
- =libappindicator3= (optional, to show =telega= icon/info in system tray)

=make= is found in most of the modern machines. The other packages can
be download with the system package manager (such as =apt= for
Debian-based distributions, =dnf= for Fedora or =pacman= for
Arch-based).

** MacOS users
:PROPERTIES:
:CUSTOM_ID: macos-users
:END:

1. If you are using [[https://emacsformacosx.com/][Emacs For Mac OS X]], or you installed Emacs by
   running ~$ brew cask install emacs~, make sure you installed a
   recent enough version (>= =emacs-27.1-mac-8.1=, you can check your
   version by running ~$ brew info emacs-mac~ or ~$ brew cask info
      emacs-mac~) with rsvg support (~$ brew install emacs-mac
      --with-rsvg~), or your Emacs may not display some media correctly,
   in this case consider switching to [[https://github.com/d12frosted/homebrew-emacs-plus][emacs-plus]].

2. If you are using [[https://bitbucket.org/mituharu/emacs-mac/][Emacs-mac]], or you installed Emacs by running ~$
      brew install emacs-mac~ or ~$ brew cask install emacs-mac~, your
   Emacs has bug dealing with complex svg, which leads to Emacs
   hangups.  Compiling Emacs with rsvg support by running ~$ brew
      install emacs-mac --with-rsvg~ will fix this problem.

   NOTE: =telega= cannot display stickers correctly with emacs-mac,
   even when emacs-mac is compiled with rsvg support.  If you want
   sticker support, please consider switching to emacs-plus.

3. [[https://github.com/d12frosted/homebrew-emacs-plus][emacs-plus]] is the best choice to run =telega=.

** Linux users
:PROPERTIES:
:CUSTOM_ID: linux-users
:END:

=telega= requires at least GNU Emacs 26.1 with optional, but highly
recommended, =svg= support. If Emacs version is less then 27.1, then
=imagemagick= is also required.  Most distributions provide GNU Emacs
compiled with these dependencies when installing GNU Emacs with GTK+
support (graphical).

** Building TDLib
:PROPERTIES:
:CUSTOM_ID: building-tdlib
:END:

[[https://core.telegram.org/tdlib][TDLib]] is the library for building Telegram clients. It requires a
large amount of memory to be built.  Make sure you are using TDLib
version greater or equal to 1.7.0.

On MacOS you can install a pre-built =TDLib= package using homebrew from
[[https://brew.sh][brew.sh]].  Just run:
#+begin_src shell
  $ brew install tdlib
#+end_src

On Linux, you will need to build =TDLib= from source.

To get the source:
#+begin_src shell
  $ git clone https://github.com/tdlib/td.git
#+end_src

Move into the folder with ~$ cd ./td~ or wherever you checked out
=td=.

Prepare a folder for building the library:
#+begin_src shell
  $ mkdir build && cd build && cmake ../
#+end_src

Build the sources:
#+begin_src shell
  $ make -jN
#+end_src

with ~N~ number of cores that should be used for the compilation (the
optimal value is the number of physical cores on the machine).

Finally, to install the library system-wide:
#+begin_src shell
  $ sudo make install
#+end_src

It will install headers to =/usr/local/include= and library itself
into =/usr/local/lib=.  If you have TDLib installed in other location,
don't forget to modify ~telega-server-libs-prefix~ before starting
=telega=.

** Installing telega and TDLib from [[https://guix.gnu.org/][GNU Guix]]
:PROPERTIES:
:CUSTOM_ID: installing-telega-and-tdlib-from-gnu-guix
:END:

=telega= and =TDLib= are both available in GNU Guix. If you have a
resource constrained machine or would simply prefer to bypass
compiling =TDLib= from source, this is a good option!

On Guix System:
#+begin_src shell
  $ guix package -i emacs-telega font-gnu-{unifont,freefont}
#+end_src

The latter two packages provide glyphs used by =telega=.

On "Foreign" Distributions:
- Use the shell installer script, or install GNU Guix manually on-top
  of your current distribution. [[https://guix.gnu.org/manual/en/html_node/Installation.html#Installation][Installation Documentation]]

- Enable fetching substitutes from the build server cache if you do
  not wish to build from source. [[https://guix.gnu.org/manual/en/html_node/Substitute-Server-Authorization.html#Substitute-Server-Authorization][Substitute Server Authorization]]

- And finally, run:
  #+begin_src shell
    $ guix package -i emacs emacs-telega
  #+end_src

It is easiest to use the version of Emacs installed from GNU Guix
because it is modified with an autoloader to identify and
automatically use Emacs packages installed from Guix. Alternatively,
if you wish to use the bundle of Emacs provided by your distribution,
you may install the =telega= elisp sources through MELPA and use Guix
to provide the server binary precompiled.

Consult the official GNU Guix documentation for further
questions. Issues related to the GUIX package must be accompanied by
the [[https://github.com/zevlg/telega.el/labels/guix][GUIX label]] in the issue tracker.

Do note that since =telega= is actively maintained installations from
Guix might at times lag behind master, but regular attempts to keep it
updated will occur.  If the version in Guix is too outdated or is
missing a feature, please use the protocol for the issue tracker.

** Installing telega from MELPA
:PROPERTIES:
:CUSTOM_ID: installing-telega-from-melpa
:END:

=telega= is available from [[https://melpa.org][MELPA]], so you can install it from there as
usual package.  This is a preferable method, because it will
automatically handle all dependencies and provides autoloads.

For TDLib 1.7.0 release you might
consider stable =telega= version.  Stable =telega= version won't
require you to rebuild TDLib until next TDLib 1.8.0 release, =telega= updates will work with
1.7.0.  Stable =telega= is placed
in [[https://stable.melpa.org/][MELPA Stable]].  Package configuration for =telega= from MELPA Stable
might look like:
#+begin_src emacs-lisp
  (add-to-list 'package-archives
  	     '("melpa-stable" . "https://stable.melpa.org/packages/"))
  (add-to-list 'package-pinned-packages '(telega . "melpa-stable"))
#+end_src

=telega= from unstable [[https://melpa.org][MELPA]] is a bleeding edge of the =telega=
development and =telega= updates might require also TDLib
update/rebuild sometimes.  However, it brings you all newer (probably
incompatible with TDLib 1.7.0)
functionality faster, no need to wait for TDLib 1.8.0 to access newer features.

Or you could use git repository with this melpa-style recipe for [[https://github.com/quelpa/quelpa][quelpa]]:

#+begin_src emacs-lisp
  (quelpa '(telega :fetcher github
  		 :repo "zevlg/telega.el"
  		 :branch "master"
  		 :files (:defaults "contrib" "etc" "server" "Makefile")))
#+end_src

** Installing telega directly from GitHub
:PROPERTIES:
:CUSTOM_ID: installing-telega-directly-from-github
:END:

Make sure dependencies are installed with @@html:<kbd>@@M-x package-install RET visual-fill-column RET@@html:</kbd>@@ and @@html:<kbd>@@M-x package-install RET rainbow-identifiers RET@@html:</kbd>@@.

Get the source:
#+begin_src shell
  $ git clone https://github.com/zevlg/telega.el
  $ cd telega.el
  $ make compile
#+end_src

Finally load =telega= into Emacs using:
#+begin_src emacs-lisp
  (use-package telega
    :load-path  "~/telega.el"
    :commands (telega)
    :defer t)
#+end_src

Or with:
#+begin_src emacs-lisp
  (add-to-list 'load-path "~/telega.el")
  (require 'telega)
#+end_src

The code should be put in the configuration file for Emacs, which
usually is =init.el=, or =emacs.el=.

* Getting started
:PROPERTIES:
:CUSTOM_ID: getting-started
:END:

Start =telega= with @@html:<kbd>@@M-x telega RET@@html:</kbd>@@. The first time it will
ask for the phone number you have associated with the Telegram
network.

Some options affecting =TDLib= runtime:
- User Option: ~telega-directory~ 

  Directory for telega runtime files. 

  Default value: ~"/home/lg/.telega"~
- User Option: ~telega-options-plist~ 

  Plist of options to set.
  To use custom language pack (from "tdesktop" localization target),
  add ~:language_pack_id~ option.
  Only writable options can be set.  See: https://core.telegram.org/tdlib/options 

  Default value: ~(:online t :localization_target "tdesktop")~
- User Option: ~telega-proxies~ 

  List of proxies.
  Format is:
    (:server "<SERVER>" :port <PORT> :enable <BOOL> :type <PROXY-TYPE>)

  where PROXY-TYPE is one of:
    (:@type "proxyTypeSocks5" :username <USER> :password <PASSWORD>)
    (:@type "proxyTypeHttp" :username <USER> :password <PASSWORD>
  	 :http_only <BOOL>)
    (:@type "proxyTypeMtproto" :secret <SECRET-STRING>)

  <BOOL> is either t or ~:false~, nil is not valid value. 

  Default value: ~nil~
- User Option: ~telega-my-location~ 

  Set to non-nil to use this as location of me.
  Plist in form (:latitude <LAT> :longitude <LONG>)
  To publically expose this location set ~:is_location_visible~ to
  non-nil in ~telega-options-plist~.
  Used to calculate distances from other peers to me. 

  Default value: ~nil~

To list all available customizable user options use ~M-x
customize-group RET telega RET~ command.

* Settings for Emacs As Daemon
:PROPERTIES:
:CUSTOM_ID: settings-for-emacs-as-daemon
:END:

Some people starts Emacs in daemon mode, i.e. =emacs --daemon=.  Such
Emacs instance has no frames, frames are created when needed and
connects to the daemon process.

=telega= autodetects values for some variables at start by examining
current frame parameters and window system possibilities.  This won't
work in daemon mode.  You need to explicitly specify values for that
variables.  Most notable options are:
- User Option: ~telega-use-images~ 

  Non-nil to show images.
  Explicitly set it to non-nil if using Emacs as a service and
  want to create X frames to show images.
  See https://zevlg.github.io/telega.el/#settings-for-emacs-as-daemon 

  Default value: ~nil~
- User Option: ~telega-emoji-font-family~ 

  Font to use for emoji image generation using ~telega-emoji-create-svg~. 

  Default value: ~nil~
- User Option: ~telega-emoji-use-images~ 

  Non-nil to use images for emojis. 

  Default value: ~nil~
- User Option: ~telega-online-status-function~ 

  Function used to determine if user is online.
  Function should return non-nil if user is online, and nil if offline.
  See https://github.com/zevlg/telega.el/issues/171 

  Default value: ~telega-focus-state~

* Telega glossary
:PROPERTIES:
:CUSTOM_ID: telega-glossary
:END:

Before start, please read [[https://core.telegram.org/tdlib/getting-started#tdlib-glossary][TDLib glossary]]

=telega= tries to keep TDLib's terminology, however introduces some
new terms specific to =telega=.  All of them are used in the manual.

- Root Buffer a.k.a. rootbuf :: 
     Buffer with list of chats, you see it just after @@html:<kbd>@@M-x telega RET@@html:</kbd>@@.
     Most of the time rootbuf term is used in the manual.
     See [[#root-buffer][Root Buffer]]

- Root View :: 
     Root Buffer can be shown in different ways.  Way rootbuf is shown is
     called root view.
     See [[#root-buffer][Root Buffer]]

- Chat Buffer a.k.a. chatbuf :: 
     Buffer with chat contents.
     See [[#chat-buffer][Chat Buffer]]

- Button :: 
     Ordinary Emacs Button (see =button.el=).  Some outlined area with
     text, that can be acted on.  Pressing @@html:<kbd>@@RET@@html:</kbd>@@ on the
     button, executes button action.  There are many buttons of different
     kind in =telega=

- Chat Button :: 
     Button referring to some chat.  Action for such button is to open
     corresponding chatbuf.

     rootbuf lists the chat buttons, such as:
     #+begin_example
       {🎗Saved Messages            }📌  📹 Video (10s)               Fri✓
       [Emacs | Emacs (english)     ]  @oldosfan: same                Fri
       ...
     #+end_example

- Chat Filter :: 
     S-exp expression used to match chats.
     See [[#chat-filters][Chat Filters]] for the details.

- Active Chat Filter :: 
     Chat filter applied to the chat list in rootbuf.

     Only chats matching active chat filter are displayed in rootbuf.
     Active chat filter is displayed above the chat list in rootbuf, such
     as:
     #+begin_example
       -/------------------------------(main)--------------------------------
     #+end_example

     ~(telega-filter-active)~ returns active chat filter.

  - User Option: ~telega-filter-default~ 

    Default chat filter to apply. 

    Default value: ~main~

- Custom Chat Filter :: 
     Chat filter associated with a name.

     Custom chat filters are displayed as buttons above the chat list in
     the rootbuf, such as:
     #+begin_example
       [243:📑Main      4890]  [51:Groups       4677]  [27:Channels      210]
       [53:Contacts         ]  [0:Important         ]  [3:📑Archive      670]
     #+end_example

     Action for such buttons is to add corresponding chat filter to
     active chat filter.

     However, buttons that corresponds to a Telegram Folder, including
     "Main" and "Archive", substitutes folder in active chat filter with
     new one at button.

  - User Option: ~telega-filter-button-width~ 

    Width of the custom filter buttons. 

    Default value: ~20~
  - User Option: ~telega-filters-custom~ 

    Alist of custom filters in form (NAME . CHAT-FILTER).
    NAME is evaluated to get resulting string, so it could be a lisp
    form.
    This filters are displayed as filter buttons at the top of rootbuf. 

    Default value: 
    #+begin_src emacs-lisp
      (("Main" . main)
       ("Groups" type basicgroup supergroup)
       ("Channels" type channel)
       ("Online" and
        (not saved-messages)
        (online-status "Online"))
       ("Important" or mention
        (and unread unmuted))
       ("Archive" . archive))
    #+end_src

  - User Option: ~telega-filter-custom-expand~ 

    Non-nil to expand custom filter when adding to active filters. 

    Default value: ~t~
  - User Option: ~telega-filter-custom-show-folders~ 

    Non-nil to show telegram folders along the side with custom filters. 

    Default value: ~t~

- Chat Sort Criteria :: 
     List of symbols denoting how to sort chats.
     See [[#sorting-chats][Sorting Chats]]

- Active Sort Criteria a.k.a. active sorter :: 
     Sort criteria applied to the chat list in rootbuf.

     By default, chats are sorted according to internal Telegram order
     (except for chats with custom order).

     In case active sorter is enabled, it is displayed above the chat
     list in rootbuf, such as:
     #+begin_example
       -\---------------------(unread-count join-date)-----------------------
     #+end_example

- Me user a.k.a. me :: 
     User currently logged in, ~(telega-user-me)~ returns me.

     me means you, not me.

     Chat with me is also known as "Saved Messages".

* Telega prefix map
:PROPERTIES:
:CUSTOM_ID: telega-prefix-map
:END:

=telega= has prefix map for common =telega= commands, such as
switching to rootbuf, switch to "Saved Messages", sending current
buffer as file to a chat, switching accounts, opening chat or
switching to some chat.

It is convenient to have it somewhere accessible from ~global-map~,
say @@html:<kbd>@@C-c t@@html:</kbd>@@.  To do so use next code in your =init.el=:

#+begin_src
  (define-key global-map (kbd "C-c t") telega-prefix-map)
#+end_src

Or if =telega= is not accessible to autoload at start time, then use:

#+begin_src
  (add-hook 'telega-load-hook
  	  (lambda ()
  	    (define-key global-map (kbd "C-c t") telega-prefix-map)))
#+end_src

Telega prefix map bindings:

- @@html:<kbd>@@t@@html:</kbd>@@ (~telega~) :: 
     Start telega.el Telegram client.
     Pop to root buffer.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is specified, then do not pop to root buffer.

- @@html:<kbd>@@c@@html:</kbd>@@ (~telega-chat-with~) :: 
     Start messaging with ~CHAT-OR-USER~.

- @@html:<kbd>@@i@@html:</kbd>@@ (~telega-switch-important-chat~) :: 
     Switch to important ~CHAT~ if any.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is used, then select first chat if
     multiple chats are important.

- @@html:<kbd>@@s@@html:</kbd>@@ (~telega-saved-messages~) :: 
     Switch to "Saved Messages" chat buffer.
     If "Saved Messages" chat is not opened, then open it.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is specified, then goto prompt otherwise
     keep the point, where it is.

- @@html:<kbd>@@b@@html:</kbd>@@ (~telega-switch-buffer~) :: 
     Interactively switch to chat ~BUFFER~.

- @@html:<kbd>@@f@@html:</kbd>@@ (~telega-buffer-file-send~) :: 
     Prepare ~FILE~ to be sent as document or photo to ~CHAT~.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is specified, then always send as a file.
     Otherwise for ~image-mode~ major-mode, send file as photo.
     If called interactively, then file associated with current buffer
     is used as ~FILE~.
     If current buffer is dired, then send all marked files.

- @@html:<kbd>@@w@@html:</kbd>@@ (~telega-browse-url~) :: 
     Open the ~URL~.
     If ~URL~ can be opened directly inside telega, then do it.
     Invite links and link to users can be directly opened in telega.
     If ~IN-WEB-BROWSER~ is non-nil then force opening in web browser.

- @@html:<kbd>@@a@@html:</kbd>@@ (~telega-account-switch~) :: 
     Switch to the ~ACCOUNT-NAME~.

* Root Buffer
:PROPERTIES:
:CUSTOM_ID: root-buffer
:END:

rootbuf is the heart of the =telega=.  Switch to rootbuf with
@@html:<kbd>@@M-x telega RET@@html:</kbd>@@ or use
@@html:<kbd>@@t@@html:</kbd>@@ (~telega~) binding from the
[[#telega-prefix-map][Telega prefix map]].

*TODO*: describe parts of the rootbuf: status, custom-filters,
*folders, active chat filter, active chat sorter

rootbuf lists chats filtered by active chat filter.  Press
@@html:<kbd>@@h@@html:</kbd>@@, @@html:<kbd>@@i@@html:</kbd>@@ (~telega-describe-chat~) to get
detailed description of the chat at point.

Important customizable options:
- User Option: ~telega-root-fill-column~ 

  Maximum width to use in root buffer to display active filters and chats. 

  Default value: ~70~
- User Option: ~telega-root-keep-cursor~ 

  Non-nil to keep cursor at current chat, even if chat's order changes.
  Set to ~track~, to move cursor to corresponding chat button, when
  chat buffers are switched, useful in side-by-side window setup
  for rootbuf and chatbuf.

  Consider setting ~switch-to-buffer-preserve-window-point~ to nil,
  to make ~telega-root-keep-cursor~ always work as expected. 

  Default value: ~track~

** Rootbuf fast navigation
:PROPERTIES:
:CUSTOM_ID: rootbuf-fast-navigation
:END:

@@html:<kbd>@@M-g@@html:</kbd>@@ prefix in rootbuf is used to jump across chat buttons:

- @@html:<kbd>@@M-g u@@html:</kbd>@@ (~telega-root-next-unread~) :: 
     Move point to the next chat with unread message.

- @@html:<kbd>@@M-g i@@html:</kbd>@@ (~telega-root-next-important~) :: 
     Move point to the next chat with important messages.

     Important message is a message matching "Important" custom
     [[#chat-filters][chat filter]].  If there is no "Important"
     custom chat filter, then ~(or mention (and unread unmuted))~
     chat filter is used.

- @@html:<kbd>@@M-g @@@html:</kbd>@@, @@html:<kbd>@@M-g m@@html:</kbd>@@ (~telega-root-next-mention~) :: 
     Move point to the next chat with mention.

** Rootbuf view switching
:PROPERTIES:
:CUSTOM_ID: rootbuf-view-switching
:END:

Rootbuf view is the specific way how rootbuf is shown to the user.  By
default, list of the chats is shown, this is known as default root
view.

@@html:<kbd>@@v@@html:</kbd>@@ prefix in rootbuf is used to switch root views:
- @@html:<kbd>@@s@@html:</kbd>@@, @@html:<kbd>@@v s@@html:</kbd>@@ (~telega-view-search~) :: 
     View ~QUERY~ search results.

- @@html:<kbd>@@v n@@html:</kbd>@@ (~telega-view-nearby~) :: 
     View contacts and chats nearby ~telega-my-location~.

- @@html:<kbd>@@v v@@html:</kbd>@@ (~telega-view-reset~) :: 
     Reset rootview to the default value.

- @@html:<kbd>@@v 0@@html:</kbd>@@ (~telega-view-compact~) :: 
     Compact view for the rootbuf.

- @@html:<kbd>@@v 1@@html:</kbd>@@ (~telega-view-one-line~) :: 
     View chat list as one line.

- @@html:<kbd>@@v 2@@html:</kbd>@@ (~telega-view-two-lines~) :: 
     View chat list as 2 lines.

- @@html:<kbd>@@v t@@html:</kbd>@@ (~telega-view-topics~) :: 
     Group chats by ~telega-root-view-topics~.

     Customizable options:
  - User Option: ~telega-root-view-topics~ 

    Alist of topics for "topics" root view.
    Car is name of the topic, cdr is chat filter to match chats. 

    Default value: 
    #+begin_src emacs-lisp
      (("Important" or mention
        (and unread unmuted)))
    #+end_src

  - User Option: ~telega-root-view-topics-folders~ 

    Non-nil to add Chat Folders to the list of topics.
    Could be one of ~prepend~, ~append~ or nil. 

    Default value: ~append~
  - User Option: ~telega-root-view-topics-other-chats~ 

    Non-nil to show other chats in the "topics" root view. 

    Default value: ~t~

- @@html:<kbd>@@v F@@html:</kbd>@@ (~telega-view-files~) :: 
     View status of files known to telega.
     File can be in one of the state kinds: "downloading", "uploading",
     "partially-downloaded", "partially-uploaded", "downloaded".
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is specified, then query user about file
     state kinds to show. By default all kinds are shown.

     If you use this view frequently, consider setting
     ~telega-chat-upload-attaches-ahead~ to nil, to avoid file
     duplications for "uploading" kind. See
     https://github.com/tdlib/td/issues/1348#issuecomment-752654650
     for details

     Press @@html:<kbd>@@d@@html:</kbd>@@ under downloaded filename to delete the
     file.  Only files cached by TDLib in the ~telega-cache-dir~
     can be deleted.

     Customizable options:
  - User Option: ~telega-root-view-files-exclude-subdirs~ 

    Alist specifying which subdirs to exclude when viewing files.
    car of each element is predicate matching file, and rest is list of
    subdirectories to ignore, i.e. if absolute file name contains any of
    the subdirectory in list, then file is ignored.
    Supported predicates: ~telega-file--downloading-p~,
    ~telega-file--uploading-p~, ~telega-file--downloaded-p~,
    ~telega-file--uploaded-p~, ~telega-file--partially-downloaded-p~,
    ~telega-file--partially-uploaded-p~ 

    Default value: ~((telega-file--downloaded-p "thumbnails" "profile_photos"))~
  - User Option: ~telega-chat-upload-attaches-ahead~ 

    Non-nil to upload attachments ahead, before message actually sent.
    Having this non-nil "speedups" uploading, its like files uploads instantly. 

    Default value: ~t~

- @@html:<kbd>@@v T@@html:</kbd>@@ (~telega-view-top~) :: 
     View top chats in all categories.

     Customizable options:
  - User Option: ~telega-root-view-top-categories~ 

    List of top categories with limits. 

    Default value: 
    #+begin_src emacs-lisp
      (("Users" . 10)
       ("Groups" . 10)
       ("Channels" . 10)
       ("Bots" . 10)
       ("InlineBots" . 10)
       ("Calls" . 10)
       ("ForwardChats" . 10))
    #+end_src


- @@html:<kbd>@@v S@@html:</kbd>@@ (~telega-view-settings~) :: 
     View and edit your Telegram settings.

- @@html:<kbd>@@v c@@html:</kbd>@@ (~telega-view-contacts~) :: 
     View contacts searched by ~QUERY~.
     If ~QUERY~ is empty string, then show all contacts.

- @@html:<kbd>@@v C@@html:</kbd>@@ (~telega-view-calls~) :: 
     View calls.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then view missed calls only.

- @@html:<kbd>@@v l@@html:</kbd>@@ (~telega-view-last-messages~) :: 
     View last messages in the chats.

- @@html:<kbd>@@v f@@html:</kbd>@@ (~telega-view-folders~) :: 
     View Telegram folders.

- @@html:<kbd>@@v d@@html:</kbd>@@ (~telega-view-deleted-chats~) :: 
     View recently deleted chats.

Important customizable options:
- User Option: ~telega-root-default-view-function~ 

  Default view for the rootbuf. 

  Default value: ~telega-view-default~

  @@html:<kbd>@@v v@@html:</kbd>@@ (~telega-view-reset~) uses this
  function to reset root view.

* Chat Folders
:PROPERTIES:
:CUSTOM_ID: chat-folders
:END:

[[https://telegram.org/blog/folders][Telegram has added]] a new
feature that allows users to organise chats into Chat Folders.

Each folder can have unlimited number of pinned chats.

Before Telegram had support for Chat Folders, =telega= implemented
custom chat label feature, resembling Chat Folders functionality.
But now custom chat label feature is deprecated in favor to Chat
Folders.  Use @@html:<kbd>@@M-x telega-folders-migrate-custom-labels RET@@html:</kbd>@@ to migrate your custom labels into Chat Folders.

@@html:<kbd>@@F@@html:</kbd>@@ prefix in rootbuf is used to operate on Chat Folders:
- @@html:<kbd>@@F +@@html:</kbd>@@ (~telega-folder-create~) :: 
     Create new Telegram folder with name ~FOLDER-NAME~.
     Use @@html:<kbd>@@C-u@@html:</kbd>@@ to create folder with icon name.

- @@html:<kbd>@@F -@@html:</kbd>@@ (~telega-folder-delete~) :: 
     Delete Telegram folder with ~FOLDER-NAME~.
     This won't delete any chat, just a folder.

- @@html:<kbd>@@F =@@html:</kbd>@@ (~telega-folders-reorder~) :: 
     Reorder Telegram folders to be in ~ORDERED-FOLDER-NAMES~ order.

- @@html:<kbd>@@F R@@html:</kbd>@@ (~telega-folder-rename~) :: 
     Assign new name and icon to the folder with ~FOLDER-NAME~.
     Use @@html:<kbd>@@C-u@@html:</kbd>@@ to change folder's icon name as well.

- @@html:<kbd>@@F a@@html:</kbd>@@ (~telega-chat-add-to-folder~) :: 
     Add ~CHAT~ to the Telegram folder named ~FOLDER-NAME~.
     You can add chat to multiple folders.

- @@html:<kbd>@@F d@@html:</kbd>@@ (~telega-chat-remove-from-folder~) :: 
     Remove ~CHAT~ from the folder named ~FOLDER-NAME~.

Customizable options for Chat Folders:
- User Option: ~telega-root-view-topics-folders~ 

  Non-nil to add Chat Folders to the list of topics.
  Could be one of ~prepend~, ~append~ or nil. 

  Default value: ~append~

- User Option: ~telega-folder-icons-alist~ 

  Alist of symbols to be used as folder icons instead of ~telega-symbol-folder~.
  See list of all available icon names in ~telega-folder-icon-names~. 

  Default value: 
  #+begin_src emacs-lisp
    (("Favorite" . "★")
     ("Love" . "♥")
     ("Travel" . "🛫")
     ("Cat" . "🐱")
     ("Sport" . "🏅")
     ("Mask" . "😷"))
  #+end_src


- User Option: ~telega-chat-folder-format~ 

  Non-nil to prefix chat's title with chat folder.
  %I - Replaced with folder's icon from ~telega-folder-icon-names~ or
       empty string if there is no icon.
  %i - Replaced with folder's icon from ~telega-folder-format~ or
       ~telega-symbol-folder~ if there is no icon.
  %f - Replaced with folder's title.
  %F - Replaced with folder's icon from ~telega-folder-icon-names~
       if icon is unique, or equivalent to %I%f. 

  Default value: 
  #+begin_src emacs-lisp
    #("%F | " 0 5
      (face bold))
  #+end_src


- User Option: ~telega-chat-folders-exclude~ 

  Exclude these folders when determining chat's folder.
  When determining which chat folder to use in
  ~telega-chat-folders-format~, these folders are excluded, if
  single folder is left, then it is used in the formatting. 

  Default value: ~("Unread" "Personal")~

- User Option: ~telega-filter-custom-show-folders~ 

  Non-nil to show telegram folders along the side with custom filters. 

  Default value: ~t~

* Chat Filters
:PROPERTIES:
:CUSTOM_ID: chat-filters
:END:

Chat Filters are used to match chats, same as regexps are used to
match strings.  Chat Filters uses S-exp notation similar to ~rx~
package for regexps.  Consider Chat Filters as extremely powerful
"Folders" functionality in official client.

Primitive Chat Filter is a specifier to match some property of the
chat.  Each primitive Chat Filter has name (elisp symbol) and
corresponding function named ~telega--filter-<FILTER-NAME>~.
You can specify primitive Chat Filter in either way:
1. ~<FILTER-NAME>~
2. ~( <FILTER-NAME> <ARG1> [<ARG2> ...] )~

Primitive Chat Filters are combined using ~and~, ~or~ and ~not~
filters, forming final Chat Filter.  So Chat Filter is a logical
combination of other Chat Filters, down to primitive Chat Filters.

Chat Filter examples:
- ~all~ :: 
     Matches all chats

- ~(or saved-messages (type channel bot))~ :: 
     Matches bots/channels chats or "Saved Messages" chat

- ~(and unmuted (unread 10) (mention 1))~ :: 
     Matches unmuted chats with at least 10 unread messages and at
     least one message with unread mention

Matching is done using ~telega-chat-match-p~ function.

@@html:<kbd>@@/@@html:</kbd>@@ prefix in rootbuf is used for some useful filtering
commands:

- @@html:<kbd>@@/ i@@html:</kbd>@@ (~telega-filter-by-important~) :: 
     Filter important chats.
     Important chat is a chat with unread messages and enabled notifications.
- @@html:<kbd>@@/ f@@html:</kbd>@@ (~telega-filter-by-folder~) :: 
     Match chats by Telegram ~FOLDER~.
- @@html:<kbd>@@/ e@@html:</kbd>@@, @@html:<kbd>@@/ :@@html:</kbd>@@ (~telega-filters-edit~) :: 
     Edit and reapply filters list.
- @@html:<kbd>@@/ a@@html:</kbd>@@ (~telega-filter-by-filter~) :: 
     Interactively select a Chat filter to add to active filter.
- @@html:<kbd>@@/ DEL@@html:</kbd>@@, @@html:<kbd>@@/ d@@html:</kbd>@@ (~telega-filters-pop-last~) :: 
     Pop last ~N~ filters.
- @@html:<kbd>@@/ !@@html:</kbd>@@ (~telega-filters-negate~) :: 
     Negate last filter.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is specified, then negate whole active filter.
- @@html:<kbd>@@/ /@@html:</kbd>@@ (~telega-filters-reset~) :: 
     Reset active filter to the ~telega-filter-default~.

For other Chat Filter bindings see below.

** List of chat filters
:PROPERTIES:
:CUSTOM_ID: list-of-chat-filters
:END:

- (any ~FILTER-LIST~...) :: 
     Matches if any filter in ~FILTER-LIST~ matches.

- (or ~FILTER-LIST~...) :: 
     Same as ~any~

- (all ~FILTER-LIST~...) :: 
     Matches if all filters in ~FILTER-LIST~ matches.
     Also matches if ~FILTER-LIST~ is empty.

- (and ~FILTER-LIST~...) :: 
     Same as ~all~

- (not ~FILTER~) :: 
     Matches if ~FILTER~ not maches.

- (type ~CHAT-TYPE-LIST~), @@html:<kbd>@@/ t@@html:</kbd>@@ (~telega-filter-by-type~) :: 
     Matches if chat type is one of ~CHAT-TYPE-LIST~.

     Every chat has a type.  Type is one of:
  - ~private~ Private chat with a Telegram user
  - ~secret~ Secret chat with a Telegram user
  - ~bot~ Chat with a Telegram bot
  - ~basicgroup~ Small chat group, could be upgraded to supergroup
  - ~supergroup~ Chat group with all the chat possibilities
  - ~channel~ Supergroup with unlimited members, where only admins can post messages

- (name ~REGEXP~) :: 
     Matches if chat's title matches ~REGEXP~.

- (search ~QUERY~), @@html:<kbd>@@/ s@@html:</kbd>@@ (~telega-filter-by-search~) :: 
     Matches if chat maches search QUERY.

- nearby, @@html:<kbd>@@/ n@@html:</kbd>@@ (~telega-filter-by-nearby~) :: 
     Matches if chat is nearby ~telega-my-location~.

- (custom ~NAME~), @@html:<kbd>@@/ C@@html:</kbd>@@ (~telega-filter-by-custom~) :: 
     Matches if custom filter with ~NAME~ matches.

- pin, @@html:<kbd>@@/ P@@html:</kbd>@@, @@html:<kbd>@@/ ^@@html:</kbd>@@ (~telega-filter-by-pin~) :: 
     Matches if chat is pinned.

- (has-username [ ~USERNAME~ ]) :: 
     Matches if chat has username associated with the chat.

- has-pinned-message :: 
     UNAVAILABLE since TDLib 1.6.10, chat has no fast way (property)
     to get know that chat has a pinned message.  See
     https://github.com/tdlib/td/issues/1275

- (unread [ ~N~ ]), @@html:<kbd>@@/ u@@html:</kbd>@@ (~telega-filter-by-unread~) :: 
     Matches if chat has least ~N~ unread messages.
     By default ~N~ is 1.
     Also matches chats marked as unread.

- (mention [ ~N~ ]), @@html:<kbd>@@/ m@@html:</kbd>@@ (~telega-filter-by-mention~) :: 
     Matches if chat has least ~N~ unread mentions.
     By default ~N~ is 1.

- unmuted, @@html:<kbd>@@/ y@@html:</kbd>@@ (~telega-filter-by-unmuted~) :: 
     Matches if chat has enabled notifications.

- (online-status ~STATUS-LIST~...), @@html:<kbd>@@/ o@@html:</kbd>@@ (~telega-filter-by-online-status~) :: 
     Matches private chat where user status is one of ~STATUS-LIST~.

     Each element in ~STATUS-LIST~ is one of: "Online", "Offline",
     "Recently", "LastWeek", "LastMonth" or "Empty"

- verified, @@html:<kbd>@@/ v@@html:</kbd>@@ (~telega-filter-by-verified~) :: 
     Matches if chat is verified.

- (ids ~ID-LIST~...) :: 
     Matches if chat's id is one of in ~ID-LIST~.

- (me-is-owner [ ~OR-ADMIN~ ]) :: 
     Matches if me is owner of the chat.
     Only basicgroup, supergroup and channel can be owned.
     If optional ~OR-ADMIN~ is specified, then match also if me is
     administrator in the chat.

- me-is-member :: 
     Matches if me is member of the chat.
     Matches only basicgroup, supergroup or a channel.

- has-last-message :: 
     Matches if chat has last message.

- has-avatar :: 
     Matches if chat has chat photo.

- has-animated-avatar :: 
     Matches if ~CHAT~ has animated chat photo.

- has-chatbuf, @@html:<kbd>@@/ b@@html:</kbd>@@ (~telega-filter-by-has-chatbuf~) :: 
     Matches if chat has corresponding chatbuf.

- (permission ~PERM~) :: 
     Matches if chat has ~PERM~ set in chat permissions.
     ~PERM~ could be one of listed in ~telega-chat--chat-permisions~.

- (my-permission ~PERM~) :: 
     Matches if me has ~PERM~ permission in the chat.
     ~PERM~ could be one of in ~telega-chat--chat-permisions~ list or in
     ~telega-chat--admin-permissions~ list.

- (restriction ~SUFFIX-LIST~...), @@html:<kbd>@@/ r@@html:</kbd>@@ (~telega-filter-by-restriction~) :: 
     Matches restricted chats.
     ~SUFFIX-LIST~ is a list of suffixes to filter on.
     Suffix can be one of:
  - "-all"      - All platforms
  - "-ios"      - For iOS devices
  - "-android"  - For Android devices
  - "-wp"       - Windows?

  If ~SUFFIX-LIST~ is not specified, then match any restriction reason.

  Chat restriction reason reported only if chat must be restricted
  by current client.  See
  [[https://github.com/tdlib/td/issues/1203][TDLib#1203]]

- (contact [ ~MUTUAL-P~ ]), @@html:<kbd>@@/ c@@html:</kbd>@@ (~telega-filter-by-contact~) :: 
     Matches private chats if corresponding user is a contact.
     If ~MUTUAL-P~ is non-nil, then mach only if contact is mutual.

- top, @@html:<kbd>@@/ T@@html:</kbd>@@ (~telega-filter-by-top~) :: 
     Matches if chat is in top usage.

- saved-messages :: 
     Matches only "Saved Messages" chat.

- replies-messages :: 
     Matches only "Replies" chat.

- tracking, @@html:<kbd>@@/ SPC@@html:</kbd>@@ (~telega-filter-by-tracking~) :: 
     Matches if chat is in tracking buffers list.

- last-message-by-me :: 
     Matches if chat's last message sent by me.

- (chat-list ~LIST-NAME~), @@html:<kbd>@@/ f@@html:</kbd>@@ (~telega-filter-by-folder~) :: 
     Matches if chat is in chat list named ~LIST-NAME~.
     ~LIST-NAME~ is ~main~ or ~archive~ symbol, or string naming Chat Folder.

- (folder ~FOLDER-NAMES~...), @@html:<kbd>@@/ f@@html:</kbd>@@ (~telega-filter-by-folder~) :: 
     Matches if chat belongs to some Chat Folder of ~FOLDER-NAMES~.

- main :: 
     Matches if chat from "Main" chat list.

- archive :: 
     Matches if chat is archived, i.e. in "Archive" chat list.

- has-scheduled-messages :: 
     Matches if chat has scheduled messages.

- has-action-bar :: 
     Matches if chat has active action bar.

- has-reply-markup :: 
     Matches if chat has reply markup message.

- can-get-statistics :: 
     Matches if statistics available for ~CHAT~.

     Available since TDLib 1.6.9

- has-linked-chat :: 
     Matches if ~CHAT~ is supergroup and has linked chat.

- has-discussion-group :: 
     Matches if ~CHAT~ is a channel with a linked discussion group.

- has-location :: 
     Matches if ~CHAT~ is supergroup and has linked chat.

- inactive-supergroups :: 
     Matches if ~CHAT~ is inactive supergroup.

- default-disable-notification :: 
     Matches if ~CHAT~ has non-nil default disable notification setting.

- temporary-muted :: 
     Matches if ~CHAT~ is temporary muted.

** Customizable options making use of Chat Filters
:PROPERTIES:
:CUSTOM_ID: customizable-options-making-use-of-chat-filters
:END:

- User Option: ~telega-filter-default~ 

  Default chat filter to apply. 

  Default value: ~main~
- User Option: ~telega-filters-custom~ 

  Alist of custom filters in form (NAME . CHAT-FILTER).
  NAME is evaluated to get resulting string, so it could be a lisp
  form.
  This filters are displayed as filter buttons at the top of rootbuf. 

  Default value: 
  #+begin_src emacs-lisp
    (("Main" . main)
     ("Groups" type basicgroup supergroup)
     ("Channels" type channel)
     ("Online" and
      (not saved-messages)
      (online-status "Online"))
     ("Important" or mention
      (and unread unmuted))
     ("Archive" . archive))
  #+end_src

- User Option: ~telega-use-tracking-for~ 

  Specifies Chat Filter for chats to be tracked with tracking.el.
  Make sure you have tracking.el loaded if this option is used.
  Only chats with corresponding opened chatbuf are tracked.
  Tracking notifications for telega buffers will use the
  `telega-tracking` face. 

  Default value: ~nil~
- User Option: ~telega-rainbow-color-custom-for~ 

  List of custom colors for chats.
  Each element is cons cell, where car is Chat Filter, and cdr is color. 

  Default value: ~((saved-messages))~
- User Option: ~telega-chat-prompt-show-avatar-for~ 

  Show chat avatar nearby prompt input for chats matching this Chat Filter. 

  Default value: ~nil~
- User Option: ~telega-chat-group-messages-for~ 

  Chat Filter for chats where to group messages by sender. 

  Default value: 
  #+begin_src emacs-lisp
    (not
     (or saved-messages
         (type channel bot)))
  #+end_src

- User Option: ~telega-chat-show-deleted-messages-for~ 

  Chat Filter for chats where to show deleted messages in chatbuf. 

  Default value: ~nil~
- User Option: ~telega-chat-use-date-breaks-for~ 

  Chat Filter for chats where to insert date breaks.
  Date break is a special mark separating two messages received on
  different days. Such as:
  #+begin_example
    MSG1                              <--- msg sent on 27dec
    -------(28 December 2020)------   <--- date break
    MSG2                              <--- msg sent on 28dec
  #+end_example

  Default value: ~all~
- User Option: ~telega-root-view-topics~ 

  Alist of topics for "topics" root view.
  Car is name of the topic, cdr is chat filter to match chats. 

  Default value: 
  #+begin_src emacs-lisp
    (("Important" or mention
      (and unread unmuted)))
  #+end_src


* Sorting chats
:PROPERTIES:
:CUSTOM_ID: sorting-chats
:END:

It is possible to sort chats in rootbuf out of Telega built-in
order.  Sorting chats is done by some criteria.  Built-in criterias
are in ~telega-sort-criteria-alist~.  Do not insert criterias
directly into ~telega-sort-criteria-alist~, use
~define-telega-sorter~ instead.

@@html:<kbd>@@\@@html:</kbd>@@ prefix in rootbuf is used for sorting commands:

- @@html:<kbd>@@\ \@@html:</kbd>@@ (~telega-sort-reset~) :: 
     Reset active sorter.

     It is possible to add multiple criteria using ~telega-sort-reset~
     with prefix argument @@html:<kbd>@@C-u@@html:</kbd>@@.

- @@html:<kbd>@@\ s@@html:</kbd>@@, @@html:<kbd>@@\ a@@html:</kbd>@@ (~telega-sort-by-sorter~) :: 
     Interactively add ~CRITERIA~ to active sorter.
     If prefix ~ARG~ is used, then add sort criteria, instead of
     overwriting currently active one.

     Use this command to reset active sorter.

For other sorting keybindings see below.

** Sorting criteria
:PROPERTIES:
:CUSTOM_ID: sorting-criteria
:END:

- ~unread-count~, @@html:<kbd>@@\ u@@html:</kbd>@@ (~telega-sort-by-unread-count~) :: 
     Sort chats by number of unread messages in chat.

- ~title~, @@html:<kbd>@@\ t@@html:</kbd>@@ (~telega-sort-by-title~) :: 
     Sort chats alphabetically by chat title.

     Thanks to https://t.me/Kurvivor

- ~member-count~, @@html:<kbd>@@\ m@@html:</kbd>@@ (~telega-sort-by-member-count~) :: 
     Sort chats by number of members in the chat.

- ~online-members~, @@html:<kbd>@@\ o@@html:</kbd>@@ (~telega-sort-by-online-members~) :: 
     Sort chats by number of online members.

- ~join-date~, @@html:<kbd>@@\ j@@html:</kbd>@@ (~telega-sort-by-join-date~) :: 
     Sort chats by join date.  Last joined chats goes first.

- ~chatbuf-recency~, @@html:<kbd>@@\ v@@html:</kbd>@@ (~telega-sort-by-chatbuf-recency~) :: 
     Sort chats by chatbuf recency.  Recently used chats goes first.

- ~chatbuf-visibility~ :: 
     Sort chats by visibility in other window in DWIM style.
     See https://github.com/zevlg/telega.el/issues/165

- ~nearby-distance~ :: 
     Sort chats by nearby distance to me.
     See https://github.com/zevlg/telega.el/issues/165

- ~chats-in-common~ :: 
     Sort by number of chats in common.
     See https://github.com/zevlg/telega.el/issues/218

- ~last-seen~ :: 
     Sort by last seen activity.
     For private chats user's last seen date is taken.
     For other chats date of the last message is taken.

** Customizable options making use of sorting criteria
:PROPERTIES:
:CUSTOM_ID: customizable-options-making-use-of-sorting-criteria
:END:

- User Option: ~telega-chat-completing-sort-criteria~ 

  Criteria to sort chats in ~telega-completing-read-chat~. 

  Default value: ~(chatbuf-visibility chatbuf-recency)~
- User Option: ~telega-chat-switch-buffer-sort-criteria~ 

  Criteria to sort open chats when switching with ~telega-switch-buffer~. 

  Default value: ~chatbuf-recency~

* Chat buffer
:PROPERTIES:
:CUSTOM_ID: chat-buffer
:END:

Chatbuf is a Emacs buffer showing some Telegram chat.  Chatbuf
consists of a list of chat messages and an input for your messages
to send.  Press
@@html:<kbd>@@i@@html:</kbd>@@ (~telega-describe-message~) to
get detailed description of the message at point.

Important customizable options:
- User Option: ~telega-chat-fill-column~ 

  Column to fill chat messages to. 

  Default value: ~70~
- User Option: ~telega-chat-use-date-breaks-for~ 

  Chat Filter for chats where to insert date breaks.
  Date break is a special mark separating two messages received on
  different days. Such as:
  #+begin_example
    MSG1                              <--- msg sent on 27dec
    -------(28 December 2020)------   <--- date break
    MSG2                              <--- msg sent on 28dec
  #+end_example

  Default value: ~all~

** Chatbuf fast navigation
:PROPERTIES:
:CUSTOM_ID: chatbuf-fast-navigation
:END:

@@html:<kbd>@@M-g@@html:</kbd>@@ prefix in chatbuf is used to jump across various chat
messages:
- @@html:<kbd>@@M-g <@@html:</kbd>@@ (~telega-chatbuf-history-beginning~) :: 
     Jump to the first message in the chat history.

- @@html:<kbd>@@M-g r@@html:</kbd>@@, @@html:<kbd>@@M-g >@@html:</kbd>@@ (~telega-chatbuf-read-all~) :: 
     Jump to the last message in the chat history and mark all messages as read.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is used, then reset active messages filter.

- @@html:<kbd>@@M-g @@@html:</kbd>@@, @@html:<kbd>@@M-g m@@html:</kbd>@@ (~telega-chatbuf-next-unread-mention~) :: 
     Goto next unread mention in chat buffer.

- @@html:<kbd>@@M-g u@@html:</kbd>@@ (~telega-chatbuf-next-unread~) :: 
     Goto next uneard message in chat.
     ~BUTTON-CALLBACK~ - callback to call with single argument - message
     button.

- @@html:<kbd>@@M-g ^@@html:</kbd>@@, @@html:<kbd>@@M-g P@@html:</kbd>@@ (~telega-chatbuf-goto-pinned-message~) :: 
     Goto next pinned message for the chatbuffer.

- @@html:<kbd>@@M-g x@@html:</kbd>@@ (~telega-chatbuf-goto-pop-message~) :: 
     Pop message from ~telega-chatbuf--messages-pop-ring~ and goto it.

** Sending ordinary messages
:PROPERTIES:
:CUSTOM_ID: sending-ordinary-messages
:END:

Type a text in the chatbuf input and press @@html:<kbd>@@RET@@html:</kbd>@@ to send the
message.  To insert newline in the middle of the input use ordinary
@@html:<kbd>@@C-j@@html:</kbd>@@ Emacs command.

You can apply markup to the input when sending message.  This is
controlled by number of @@html:<kbd>@@C-u@@html:</kbd>@@ pressed before @@html:<kbd>@@RET@@html:</kbd>@@
and value of the:
- User Option: ~telega-chat-input-markups~ 

  Markups to apply when sending input with @@html:<kbd>@@RET@@html:</kbd>@@. 

  Default value: ~(nil "markdown1" "markdown2")~

Markdown markup syntax for "markdown1" and "markdown2" markups:
#+begin_example
  1. *bold text*
  2. _italic text_
  2.1) __underline text__    (only for "markdown2")
  2.2) ~strike through text~ (only for "markdown2")
  3. `inlined code`
  4. ```<language-name-not-displayed>
      first line of multiline preformatted code
      second line
      last line```
  5. [link text](http://actual.url)
  6. [username](tg://user?id=<USER-ID>)"
#+end_example

Also, you can intermix various markups, using @@html:<kbd>@@C-c C-a markup RET@@html:</kbd>@@ command.

To send media, along the side with the text message, use [[#attaching-media][media
attaching]] commands.

Important customizable options:
- User Option: ~telega-chat-input-markups~ 

  Markups to apply when sending input with @@html:<kbd>@@RET@@html:</kbd>@@. 

  Default value: ~(nil "markdown1" "markdown2")~
- User Option: ~telega-chat-markup-functions~ 

  List of markups to use on ~C-c C-a markup RET~. 

  Default value: 
  #+begin_src emacs-lisp
    (("markdown1" . telega-markup-markdown1-fmt)
     ("markdown2" . telega-markup-markdown2-fmt)
     ("html" . telega-markup-html-fmt)
     ("org" . telega-markup-org-fmt))
  #+end_src

- User Option: ~telega-chat-ret-always-sends-message~ 

  Non-nil to make @@html:<kbd>@@RET@@html:</kbd>@@ always send a message.
  Otherwise
  @@html:<kbd>@@RET@@html:</kbd>@@
  sends a message only if point is at the end of the chatbuf input or
  inserts newline otherwise. 

  Default value: ~t~

** Attaching media
:PROPERTIES:
:CUSTOM_ID: attaching-media
:END:

You can attach various media into chatbuf input, using next bindings:
- @@html:<kbd>@@C-c C-a@@html:</kbd>@@ (~telega-chatbuf-attach~) :: 
     Attach something to the chatbuf input.
     @@html:<kbd>@@C-u@@html:</kbd>@@ is passed directly to the attachment function.
     See ~telega-chat-attach-commands~ for available attachment types.

- @@html:<kbd>@@C-c C-f@@html:</kbd>@@ (~telega-chatbuf-attach-media~) :: 
     Attach ~FILENAME~ as media, detecting media type by ~FILENAME~ extension.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach as file.

- @@html:<kbd>@@C-c C-v@@html:</kbd>@@ (~telega-chatbuf-attach-clipboard~) :: 
     Attach clipboard image to the chatbuf as photo.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach clipboard as document.

Attachment types to attach with
@@html:<kbd>@@C-c C-a@@html:</kbd>@@ (~telega-chatbuf-attach~) defined in
~telega-chat-attach-commands~ user option:
- photo :: Attach ~FILENAME~ as photo to the chatbuf input.
- self-destruct-photo :: Attach a file as self destructing photo.
     This attachment can be used only in private chats.
- video :: Attach ~FILENAME~ as video to the chatbuf input.
- self-destruct-video :: Attach a file as self destructing video.
     This attachment can be used only in private chats.
- video-note :: Attach a (circled) video note to the chatbuf input.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach existing file as
     video-note.  Otherwise record video note inplace.
     ~telega-vvnote-video-cmd~ is used to record video notes.
- audio :: Attach ~FILENAME~ as audio to the chatbuf input.
- voice-note :: Attach a voice note to the chatbuf input.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach existing file as
     voice-note.  Otherwise record voice note inplace.
     ~telega-vvnote-voice-cmd~ is used to record voice notes.
- file :: Attach ~FILENAME~ as document to the chatbuf input.
- gif :: Attach ~GIF-FILE~ as animation to the chatbuf input.
- location :: Attach location to the chatbuf input.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach live location.
- poll :: Attach poll to the chatbuf input.
     Can be used only in group chats.
     ~QUESTION~ - Title of the poll.
     ~ANONYMOUS-P~ - Non-nil to create anonymous poll.
     ~ALLOW-MULTIPLE-ANSWERS-P~ - Non-nil to allow multiple answers.
     ~OPTIONS~ - List of strings representing poll options.
- contact :: Attach ~CONTACT~ user to the chatbuf input.
- sticker :: Attach a sticker.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach recent or
     favorite sticker.  Otherwise choose a sticker from installed
     sticker sets.
- animation :: Attach an animation.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach animation from
     a file, otherwise choose animation from list of saved animations.
- dice :: Attach random dice roll message.
- screenshot :: Attach screenshot to the chatbuf input.
     If numeric prefix arg ~N~ is given, then take screenshot in ~N~ seconds.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then take screenshot of the screen area.
     Multiple @@html:<kbd>@@C-u@@html:</kbd>@@ increases delay before taking
     screenshot of the area.
     Uses ~telega-screenshot-function~ to take a screenshot.
- clipboard :: Attach clipboard image to the chatbuf as photo.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then attach clipboard as document.
- markup :: Attach ~MARKUP-TEXT~ using ~MARKUP-NAME~ into chatbuf.
     Using this type of attachment it is possible to intermix multiple
     markups in the chatbuf input.
     Markups are defined in the ~telega-chat-markup-functions~ user option.
- scheduled :: Mark content as scheduled.
     Send following message at ~TIMESTAMP~.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given and chat is private and
     online status of the corresponding user is known, then send
     message when user gets online.
- disable-notification :: Toggle disable-notification chat option for the subsequent chatbuf input.
     Use this attachment to disable/enable notification on the receiver side.
- enable-notification :: Toggle disable-notification chat option for the subsequent chatbuf input.
     Use this attachment to disable/enable notification on the receiver side.
- disable-webpage-preview :: Disable webpage preview for the following text message.
- code :: Interactively attach a code of the ~LANGUAGE~ into chatbuf input.
     For non-interactive code attach, use ~telega-mnz--chatbuf-attach-internal~.

Special attachment types are =disable-webpage-preview=, =scheduled=,
=disable-notification= or =enable-notification=.  They do not attach
anything, but changes options on how to send the message.  Use
=scheduled= to [[#scheduling-messages-and-reminders][schedule messages]], =disable-notification= or
=enable-notification= to trigger notification on receiver side and
=disable-webpage-preview= to disable rich web page previews for URLs
in the message text.

Customizable options for attaching media:
- User Option: ~telega-chat-upload-attaches-ahead~ 

  Non-nil to upload attachments ahead, before message actually sent.
  Having this non-nil "speedups" uploading, its like files uploads instantly. 

  Default value: ~t~
- User Option: ~telega-chat-markup-functions~ 

  List of markups to use on ~C-c C-a markup RET~. 

  Default value: 
  #+begin_src emacs-lisp
    (("markdown1" . telega-markup-markdown1-fmt)
     ("markdown2" . telega-markup-markdown2-fmt)
     ("html" . telega-markup-html-fmt)
     ("org" . telega-markup-org-fmt))
  #+end_src


** Replying and editing messages
:PROPERTIES:
:CUSTOM_ID: replying-and-editing-messages
:END:

To reply/edit the message, put point on the message you want to
reply/edit and press
@@html:<kbd>@@r@@html:</kbd>@@ (~telega-msg-reply~) to reply or
@@html:<kbd>@@e@@html:</kbd>@@ (~telega-msg-edit~) to edit.

Aux prompt will be show just above the chatbuf prompt, such as:
#+begin_example
  [✕]| Reply: @demash> Trying to install telega  M-x packag…
  (T)>>> 
#+end_example

To cancel aux prompt press on the cross button, or use
@@html:<kbd>@@C-c C-k@@html:</kbd>@@, @@html:<kbd>@@C-M-c@@html:</kbd>@@, @@html:<kbd>@@M-ESC@@html:</kbd>@@ (~telega-chatbuf-cancel-aux~)
binding.
@@html:<kbd>@@C-c C-k@@html:</kbd>@@, @@html:<kbd>@@C-M-c@@html:</kbd>@@, @@html:<kbd>@@M-ESC@@html:</kbd>@@ (~telega-chatbuf-cancel-aux~) accepts
@@html:<kbd>@@C-u@@html:</kbd>@@ prefix, if used then chatbuf's input is also canceled.

To edit your previously sent message press
@@html:<kbd>@@M-p@@html:</kbd>@@ (~telega-chatbuf-edit-prev~).

It is possible to edit message with markup text inside.  Formatting
for such messages is controlled by:
- User Option: ~telega-msg-edit-markup-spec~ 

  Cons cell specifying how to format message text when editing.
  car is a function to convert message's text to markup string.
  cdr is a markup name from ~telega-chat-markup-functions~ to use as
  markup attachment.  Use nil to edit message as is, without using
  "markup" attachment type. 

  Default value: ~(telega--fmt-text-markdown2 . "markdown2")~

  @@html:<kbd>@@e@@html:</kbd>@@ (~telega-msg-edit~) accepts
  @@html:<kbd>@@C-u@@html:</kbd>@@ prefix to edit message as-is without using markup
  attachment with markup name specified in this option.

** Forwarding messages
:PROPERTIES:
:CUSTOM_ID: forwarding-messages
:END:

To forward a message, put cursor under the message which you want to
forward and press
@@html:<kbd>@@f@@html:</kbd>@@ (~telega-msg-forward-marked-or-at-point~)
and then select a Chat to forward a message to.  To forward multiple
messages at once, mark messages with the
@@html:<kbd>@@m@@html:</kbd>@@ (~telega-msg-mark-toggle~) and then
press
@@html:<kbd>@@f@@html:</kbd>@@ (~telega-msg-forward-marked-or-at-point~)
on one of the messages.

There are few options how you can affect the way a message is forwarded:
1. @@html:<kbd>@@C-u f@@html:</kbd>@@ to forward a message copy, it will look like *you*
   sent a message.
2. @@html:<kbd>@@C-u C-u f@@html:</kbd>@@ To forward a message copy deleting or
   replacing caption it has.  Use this to forward media message with
   your own caption.

** Deleting messages
:PROPERTIES:
:CUSTOM_ID: deleting-messages
:END:

To delete a message, put cursor under the message you want to delete and press
@@html:<kbd>@@DEL@@html:</kbd>@@, @@html:<kbd>@@k@@html:</kbd>@@, @@html:<kbd>@@d@@html:</kbd>@@ (~telega-msg-delete-marked-or-at-point~).

As with [[#forwarding-messages][forwarding messages]], you can mark multiple messages to delete
with @@html:<kbd>@@m@@html:</kbd>@@ (~telega-msg-mark-toggle~).

Also, you can ban/report message sender (and delete all messages from
this sender in the chat) with
@@html:<kbd>@@B@@html:</kbd>@@ (~telega-msg-ban-sender~) when
cursor is under the message.

=telega= can keep deleted messages visible until chatbuf is
killed. This is controlled using custom variable:

- User Option: ~telega-chat-show-deleted-messages-for~ 

  Chat Filter for chats where to show deleted messages in chatbuf. 

  Default value: ~nil~

For example, to show deleted messages in all chats except for "Saved
Messages", use next:
#+begin_src emacs-lisp
  (setq telega-chat-show-deleted-messages-for '(not saved-messages))
#+end_src

** Scheduling messages and reminders
:PROPERTIES:
:CUSTOM_ID: scheduling-messages-and-reminders
:END:

To schedule a message, press @@html:<kbd>@@C-c C-a scheduled RET@@html:</kbd>@@,
select date and time to schedule message at, type text of a message
and send it as always.

Message scheduled in "Saved Messages" chat is called reminder.

Whenever a scheduled message or reminder is sent, you get a special
notification marked with a 📅, so you don't get caught off-guard by
messages you planned in the past.

** Navigating previous input
:PROPERTIES:
:CUSTOM_ID: navigating-previous-input
:END:

You can navigate your previous chatbuf input using commands:
- @@html:<kbd>@@M-p@@html:</kbd>@@ (~telega-chatbuf-edit-prev~) :: 
     Edit previously sent message.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then just copy last sent message.
- @@html:<kbd>@@M-n@@html:</kbd>@@ (~telega-chatbuf-edit-next~) :: 
     Edit message sent next to currently editing.
     If ~WITHOUT-AUX~ is specified with @@html:<kbd>@@C-u@@html:</kbd>@@, then
     instead of editing, just pop previously sent message as input.
- @@html:<kbd>@@M-r@@html:</kbd>@@ (~telega-chatbuf-input-search~) :: 
     Search for REGEX in chat input history.

     While searching input, you can use
     @@html:<kbd>@@M-p@@html:</kbd>@@ (~telega-chatbuf--input-search-input-prev~)
     and
     @@html:<kbd>@@M-n@@html:</kbd>@@ (~telega-chatbuf--input-search-input-next~)
     to cycle chatbuf input ring.

** Completing input in chatbuf
:PROPERTIES:
:CUSTOM_ID: completing-input-in-chatbuf
:END:

Powerful =company-mode= could be used to complete input in the
chatbuf.

=telega= provides few company backends, such as:

- telega-company-emoji :: Complete emojis via ~:<emoji>:~
     syntax. Completion is done using predefined set of emojis.

     Customizable Options:
  - User Option: ~telega-emoji-fuzzy-match~ 

    Non-nil to use fuzzy prefix matching.
    For example without fuzzy matches, prefix ~:jo~ will match only
    ~:joy:~, ~:joy-cat:~ and ~:joystick:~.  With fuzzy matching
    enabled it will match also ~:flag-jo:~ and ~:black-jocker:~. 

    Default value: ~t~

- telega-company-telegram-emoji :: Same as ~telega-company-emoji~, but
     uses Telegram cloud for the emojis completion.

- telega-company-username :: Complete user mentions via ~@<username>~
     syntax. Here is the screenshot, showing use of this backend:
     [[file:https://zevlg.github.io/telega/completing-usernames.jpg]]

- telega-company-botcmd :: Complete bot commands via ~/<botcmd>~
     syntax.  This backend does not complete if ~/<botcmd>~ syntax is
     used in the middle of the chatbuf input, only if ~/<botcmd>~ starts
     chatbuf input.

- telega-company-hashtag :: Complete common hashtags via ~#<hashtag>~
     syntax.

=company-mode= setup might look like:
#+begin_src elisp
  (setq telega-emoji-company-backend 'telega-company-emoji)

  (defun my-telega-chat-mode ()
    (set (make-local-variable 'company-backends)
         (append (list telega-emoji-company-backend
  		     'telega-company-username
  		     'telega-company-hashtag)
  	       (when (telega-chat-bot-p telega-chatbuf--chat)
  		 '(telega-company-botcmd))))
    (company-mode 1))

  (add-hook 'telega-chat-mode-hook 'my-telega-chat-mode)
#+end_src

Consider also using =company-posframe= Emacs package (in MELPA), so
chatbuf's contents remain untouched when completion menu pops above
the chatbuf prompt.

** Sending messages via bots
:PROPERTIES:
:CUSTOM_ID: sending-messages-via-bots
:END:

If chatbuf input starts with =@<botname> <query>= and mentioned bot
support [[https://telegram.org/blog/inline-bots][inline mode]], then pressing
@@html:<kbd>@@TAB@@html:</kbd>@@ (~telega-chatbuf-complete-or-next-link~)
will pop a special buffer with the inline results to the bot inline
~<query>~, you can use these results to send a message via bot.  Some
useful bots with [[https://telegram.org/blog/inline-bots][inline mode]] support are:

- [[https://t.me/gif][@gif]] To search and send animations
- [[https://t.me/pic][@pic]], [[https://t.me/bing][@bing]] To search and send pictures
- [[https://t.me/vid][@vid]] To search and send videos on YouTube
- [[https://t.me/foursquare][@foursquare]] - To find and send places around the world
- etc

To find out is some bot supports [[https://telegram.org/blog/inline-bots][inline mode]] or not, enter
~@<botname><SPC>~ in chatbuf input and press
@@html:<kbd>@@TAB@@html:</kbd>@@ (~telega-chatbuf-complete-or-next-link~).
If momentary help is displayed, then this bot supports inline mode.

Customizable options for inline bots:
- User Option: ~telega-known-inline-bots~ 

  List of known bots for everyday use. 

  Default value: ~("@gif" "@youtube" "@pic")~

- User Option: ~telega-inline-query-window-select~ 

  Non-nil to select window with inline query results. 

  Default value: ~t~

** Filtering chat messages a.k.a. Shared Media
:PROPERTIES:
:CUSTOM_ID: filtering-chat-messages-aka-shared-media
:END:

Message filtering means to show only some messages matching filter.
Available message filters are: =scheduled=, =search=, =by-sender=, =hashtag=, =photo=, =photo-video=, =url=, =doc=, =file=, =gif=, =audio=, =video=, =voice-note=, =video-note=, =voice-video-note=, =chat-photo=, =call=, =missed-call=, =mention=, =unread-mention=, =failed-to-send=, =pinned=

Chatbuf uses next bindings for message filtering:
- @@html:<kbd>@@C-c /@@html:</kbd>@@ (~telega-chatbuf-filter~) :: 
     Enable chat message filtering ~MSG-FILTER~.

- @@html:<kbd>@@C-c C-c@@html:</kbd>@@ (~telega-chatbuf-filter-cancel~) :: 
     Cancel any message filtering.
     If point is at some message, then keep point on this message after reseting.

- @@html:<kbd>@@C-c C-r@@html:</kbd>@@, @@html:<kbd>@@C-c C-s@@html:</kbd>@@ (~telega-chatbuf-filter-search~) :: 
     Interactively search for messages in chatbuf.
     If @@html:<kbd>@@C-u@@html:</kbd>@@ is given, then search for ~QUERY~ sent
     by some chat member, member name is queried.

** Opening files using external programs
:PROPERTIES:
:CUSTOM_ID: opening-files-using-external-programs
:END:

Document messages in Telegram has attached file in the message.  By
default =telega= opens that files inside Emacs using ~find-file~ function.  Sometimes that is not
desirable behaviour and you might want to open some files in external
application.  You can use ~org-open-file~ function for this.
Behaviour is controlled by:
- User Option: ~telega-open-file-function~ 

  Function to use to open files associated with messages.
  Called with single argument - filename to open.
  Could be used to open files in external programs.
  Set it to ~org-open-file~ to use Org mode to open files. 

  Default value: ~find-file~

Setup to open some files in external applications might look like:
#+begin_src emacslisp
  ;; ("\\.pdf\\'" . default) is already member in `org-file-apps'
  ;; Use "xdg-open" to open files by default
  (setcdr (assq t org-file-apps-gnu) 'browse-url-xdg-open)

  (setq telega-open-file-function 'org-open-file)
#+end_src

If you also want to open non-document messages as file using
~telega-open-file-function~ consider:
- User Option: ~telega-open-message-as-file~ 

  List of message types to open as file using ~telega-open-file-function~.
  Supported message types are: ~photo~, ~video~, ~audio~,
  ~video-note~, ~voice-note~, ~animation~.
  Document messages are always opens as file. 

  Default value: ~nil~

*Browse URL with custom function*

Also, you can open urls using custom functions:
- User Option: ~telega-browse-url-alist~ 

  Alist of custom url browse functions.
  Each element is in form: ~(PREDICATE-OR-REGEX . FUNCTION)~. 

  Default value: ~nil~

For example, to play youtube videos using =mpv= player, add this to config:
#+begin_src emacs-lisp
  (defun my-watch-in-mpv (url)
    (async-shell-command (format "mpv -v %S" url)))

  (add-to-list 'telega-browse-url-alist
  	     '("https?://\\(www\\.\\)?youtube.com/watch" . my-watch-in-mpv))
  (add-to-list 'telega-browse-url-alist
  	     '("https?://youtu.be/" . my-watch-in-mpv))
#+end_src

** Client side messages ignoring
:PROPERTIES:
:CUSTOM_ID: client-side-messages-ignoring
:END:

In official telegram clients all messages in group chats are displayed
even if message has been sent by blocked sender (user or chat).
=telega= has client side message ignoring feature implemented.
Ignoring messages can be done by adding function into
~telega-msg-ignore-predicates~.  This function must accept single
argument - message, and return non-nil if messages should be ignored.
For example, to ignore messages from particular user with ~id=12345~
you could add next code:

#+begin_src emacs-lisp
  (defun my-telega-ignore-12345-user (msg)
    (let ((sender (telega-msg-sender msg)))
      (and (telega-user-p sender)
  	 (= (plist-get sender :id) 12345))))

  (add-hook 'telega-msg-ignore-predicates 'my-telega-ignore-12345-user)
#+end_src

Or to ignore messages from blocked senders (users or chats), just add:

#+begin_src emacs-lisp
  (add-hook 'telega-msg-ignore-predicates 'telega-msg-from-blocked-sender-p)
#+end_src

To view recently ignored messages use
~M-x telega-ignored-messages RET~ command.

* Multiple accounts
:PROPERTIES:
:CUSTOM_ID: multiple-accounts
:END:

=telega= support multiple accounts, however only single account can be
active, i.e. you can't run account simultaneously, but you can switch
between accounts.  Notifications won't work for inactive accounts.

To switch accounts use
@@html:<kbd>@@a@@html:</kbd>@@ (~telega-account-switch~) from [[#telega-prefix-map][prefix
map]].  To setup multiple accounts use:

- User Option: ~telega-accounts~ 

  List of the accounts to be used by telega.
  Each element is a list in form:
  (ACCOUNT-NAME CUSTOM-VAR1 VAL1 CUSTOM-VAR2 VAL2 ...).
  At least ~telega-database-dir~ should be customized for each account. 

  Default value: ~nil~

  For example:
  #+begin_src emacs-lisp
    (setq telega-accounts (list
      (list "zevlg" 'telega-database-dir telega-database-dir)
      (list "Evgen2" 'telega-database-dir
        (expand-file-name "evgen2" telega-database-dir))))
  #+end_src

  Each account can have its own configuration using custom variables
  specified in account setup, and only ~telega-database-dir~ must be
  different for different accounts.

* Minor Modes
:PROPERTIES:
:CUSTOM_ID: minor-modes
:END:

=telega= ships with various minor modes you might consider to use.

** Notifications for incoming messages
:PROPERTIES:
:CUSTOM_ID: notifications-for-incoming-messages
:END:

=telega.el= can notify you about incoming messages and calls via
D-Bus notifications, however notifications are disabled by default.

Enable it with ~(telega-notifications-mode 1)~ or at =telega= load time:
#+begin_src emacs-lisp
  (add-hook 'telega-load-hook 'telega-notifications-mode)
#+end_src

In order for message to trigger notification, few conditions should be
satisfied.

Do *NOT* pop notification if:
1. Me is not member of the group chat, see
   https://github.com/zevlg/telega.el/issues/224
2. Message is ignored by
   [[#client-side-messages-ignoring][client side messages ignoring]]
3. Chat is muted and message does not contain unread mention or
   mention notification is disabled for the chat
4. Message already has been read (see ~telega-msg-seen-p~)
5. Message is older then 1 min (to avoid poping up messages on
   laptop wakeup)
6. Message is currently observable in chatbuf
7. *TODO*: If Emacs frame has focus and root buffer is current

See also [[#telega-alertel--notifications-using-alertel][Notifications using alert.el]]

** telega-mode-line-mode
:PROPERTIES:
:CUSTOM_ID: telega-mode-line-mode
:END:

Global minor mode to display =telega= status in modeline.

Enable with ~(telega-mode-line-mode 1)~ or at =telega= load time:
#+begin_src emacs-lisp
  (add-hook 'telega-load-hook 'telega-mode-line-mode)
#+end_src

Customizable options:

- User Option: ~telega-mode-line-string-format~ 

  Format in mode-line-format for ~telega-mode-line-string~. 

  Default value: 
  #+begin_src emacs-lisp
    ("   "
     (:eval
      (telega-mode-line-icon))
     (:eval
      (telega-mode-line-online-status))
     (:eval
      (when telega-use-tracking-for
        (telega-mode-line-tracking)))
     (:eval
      (telega-mode-line-unread-unmuted))
     (:eval
      (telega-mode-line-mentions 'messages)))
  #+end_src


** telega-appindicator-mode
:PROPERTIES:
:CUSTOM_ID: telega-appindicator-mode
:END:

Global minor mode to display =telega= status in system tray.  This
mode requires appindicator support in the =telega-server=.  To add
appindicator support to =telega-server=, please install
=libappindicator3-dev= system package and rebuild =telega-server=
with {{{kbd(M-x telega-server-build RET}}}.

Screenshot of system tray with enabled =telega= appindicator:
[[https://zevlg.github.io/telega/screen-appindicator.png]]

Enable with ~(telega-appindicator-mode 1)~ or at =telega= load time:
#+begin_src emacs-lisp
  (add-hook 'telega-load-hook 'telega-appindicator-mode)
#+end_src

Customizable options:
- User Option: ~telega-appindicator-show-account-name~ 

  Non-nil to show current account name in appindicator label. 

  Default value: ~t~
- User Option: ~telega-appindicator-show-mentions~ 

  Non-nil to show number of mentions in appindicator label. 

  Default value: ~t~
- User Option: ~telega-appindicator-labels~ 

  List of number labels to use for the number of unread unmuted chats.
  Use this labels instead of plain number.
  Set to nil to use plain number. 

  Default value: ~("❶" "❷" "❸" "❹" "❺" "❻" "❼" "❽" "❾" "❿" "⓫" "⓬" "⓭" "⓮" "⓯" "⓰" "⓱" "⓲" "⓳" "⓴")~

** telega-squash-message-mode
:PROPERTIES:
:CUSTOM_ID: telega-squash-message-mode
:END:

Minor mode for chatbuf to squash messages into single one while
nobody saw this.

Squashing mean adding contents of the new message to the previous
message by editing contents of the previous message.

New message in chat is squashed into your previous message only if
all the conditions are met:

1. Last message in chat is sent by you
2. Nobody seen your last message
3. Last and new message are both text messages
4. Last message can be edited
5. Last and new messages are *not* replying to any message
6. Last message has no associated web-page
7. New message has no ~messageSendOptions~ to avoid squashing
   scheduled messages or similar

Can be enabled globally in all chats matching
~telega-squash-message-mode-for~ (see below) chat filter with
~(global-telega-squash-message-mode 1)~ or by adding:

#+begin_src emacs-lisp
  (add-hook 'telega-load-hook 'global-telega-squash-message-mode)
#+end_src

Customizable options:

- User Option: ~telega-squash-message-mode-for~ 

  Chat filter for ~global-telega-squash-message-mode~.
  Global squash message mode enables message squashing only in
  chats matching this chat filter. 

  Default value: 
  #+begin_src emacs-lisp
    (not
     (or saved-messages
         (type channel)))
  #+end_src


** telega-image-mode
:PROPERTIES:
:CUSTOM_ID: telega-image-mode
:END:

Major mode to view images in chatbuf.  Same as ~image-mode~,
however has special bindings:

- @@html:<kbd>@@n@@html:</kbd>@@ (~telega-image-next~) :: 
     Show next image in chat.

- @@html:<kbd>@@p@@html:</kbd>@@ (~telega-image-prev~) :: 
     Show previous image in chat.

To view high resolution image in chatbuf with ~telega-image-mode~
press @@html:<kbd>@@RET@@html:</kbd>@@ on the message with photo.

** telega-edit-file-mode
:PROPERTIES:
:CUSTOM_ID: telega-edit-file-mode
:END:

Minor mode to edit files from Telegram messages.
In this mode @@html:<kbd>@@C-x C-s@@html:</kbd>@@ will save file to Telegram cloud.
To enable ~telega-edit-file-mode~ for files opened from message
with @@html:<kbd>@@RET@@html:</kbd>@@, use:

#+begin_src emacs-lisp
  (add-hook 'telega-open-file-hook 'telega-edit-file-mode)
#+end_src

** telega-highlight-text-mode
:PROPERTIES:
:CUSTOM_ID: telega-highlight-text-mode
:END:

=jit-lock= powered minor mode to highlight given regexp.

Similar to =hi-lock=, however supports =jit-lock= for highlighting
dynamic content.

** telega-patrons-mode
:PROPERTIES:
:CUSTOM_ID: telega-patrons-mode
:END:

Emphasize =telega=
[[https://opencollective.com/telega#section-contributors][patrons]]
by drawing special elements (telega cat ears) above the patron's
avatar, like: [[https://zevlg.github.io/telega/telega-patron-ava.png]]

In addition:
- Display "Telega Patron Since: <date>" note in the patron's Chat/User description.
- All [[https://zevlg.github.io/telega.el/#telega-storiesel--display-emacs-stories-in-the-dashboard][Emacs Stories]] from =telega= patrons are automatically considered "Featured".

If you are already =telega= patron and not in the
~telega-patrons-alist~ list, please [[https://t.me/zevlg][write
me]].

~telega-patrons-mode~ is enabled by default.

* Contributed packages
:PROPERTIES:
:CUSTOM_ID: contributed-packages
:END:

=contrib/= directory contains packages contributed to =telega.el=
project.

** /ol-telega.el/ -- Org mode links to telegram chats and messages
:PROPERTIES:
:CUSTOM_ID: ol-telegael--org-mode-links-to-telegram-chats-and-messages
:END:

Installs "telega" links to Org mode.

"telega" link can point to a chat, a message or content of a
message.

Creating links to a message content is very useful in conjuction
with [[#telega-edit-file-mode][Edit File Mode]], so you can store
your Org mode files in Telegram Cloud and create links to them in
Roam manner.

** /telega-status-history.el/ -- Global minore mode to save user's online status history
:PROPERTIES:
:CUSTOM_ID: telega-status-historyel--global-minore-mode-to-save-users-online-status-history
:END:

Saves online status history into ~telega-status-history-logs-dir~ directory.

** /telega-url-shorten.el/ -- Makes urls look nicer
:PROPERTIES:
:CUSTOM_ID: telega-url-shortenel--makes-urls-look-nicer
:END:

Minor mode for chatbuf to show shorter version for some URLs.  For
example, with ~telega-url-shorten-mode~ enabled in chatbuf, urls
like:

#+begin_example
  https://github.com/zevlg/telega.el/issues/105
  https://gitlab.com/jessieh/mood-line/issues/6
  https://www.youtube.com/watch?v=0m2jR6_eMkU
  https://ru.wikipedia.org/wiki/Душ
#+end_example

Will look like:
[[https://zevlg.github.io/telega/telega-url-shorten.png]]

Can be enabled globally in all chats matching
~telega-url-shorten-mode-for~ (see below) [[#chat-filters][chat
filter]] with ~(global-telega-url-shorten-mode 1)~ or by adding:

#+begin_src emacs-lisp
  (add-hook 'telega-load-hook 'global-telega-url-shorten-mode)
#+end_src

Depends on
[[https://github.com/domtronn/all-the-icons.el][all-the-icons]]
Emacs package.

Customizable options:

- User Option: ~telega-url-shorten-use-images~ 

  Non-nil to use images on graphics display. 

  Default value: ~nil~

- User Option: ~telega-url-shorten-regexps~
  Alist of patterns for URL shortening.

  To change ~:symbol~ or ~:svg-icon~ property for existing url
  shortening pattern use something like:
  #+begin_src
    (plist-put (cdr (assq '<LABEL> telega-url-shorten-regexps))
    	   :<PROP> <VALUE>)
  #+end_src

- User Option: ~telega-url-shorten-mode-for~ 

  Chat filter for ~global-telega-url-shorten-mode~.
  ~global-telega-url-shorten-mode~ enables urls shortening only for
  chats matching this chat filter. 

  Default value: ~all~

** /telega-alert.el/ -- Notifications using =alert.el=
:PROPERTIES:
:CUSTOM_ID: telega-alertel--notifications-using-alertel
:END:

To enable notifications using =alert.el= use:
#+begin_src emacs-lisp
  (telega-alert-mode 1)
#+end_src

Alerts for =telega.el= are fired with ~:mode 'telega-chat-mode~
value.  You might use this to customize alert rules with
~alert-add-rule~.

** /telega-dired-dwim.el/ -- Attach files from dired in DWIM style
:PROPERTIES:
:CUSTOM_ID: telega-dired-dwimel--attach-files-from-dired-in-dwim-style
:END:

This package advises ~dired-do-copy~ to attach files into visible chatbuf.

In dired, mark files you want to attach and press @@html:<kbd>@@C@@html:</kbd>@@.  If
you have some chatbuf visible, marked files will be attached in
that chatbuf.

** /telega-live-location.el/ -- Manage live location in Telega using geo.el
:PROPERTIES:
:CUSTOM_ID: telega-live-locationel--manage-live-location-in-telega-using-geoel
:END:

Enable this mode with @@html:<kbd>@@M-x global-telega-live-location-mode RET@@html:</kbd>@@

This mode installs new ~live-geo-location~ chat attach type, use it
with @@html:<kbd>@@C-c C-a live-geo-location RET@@html:</kbd>@@ in the chatbuf.

This mode requires the =geo.el= library, available at
https://git.sr.ht/~oldosfan/geo-xdg.el

Take into account that using ~geo-simulate~ backend to fake geo
location data is Telegram API ToS violation.  See 1.4 in
https://core.telegram.org/api/terms

** /telega-mnz.el/ -- Display Emacs content inside Telega messages.
:PROPERTIES:
:CUSTOM_ID: telega-mnzel--display-emacs-content-inside-telega-messages
:END:

Global minor mode to highlight code blocks inside messages.

Can be enabled globally in all chats matching
~telega-mnz-mode-for~ (see below) chat filter with
~(global-telega-mnz-mode 1)~ or by adding:

#+begin_src emacs-lisp
  (require 'telega-mnz)
  (add-hook 'telega-load-hook 'global-telega-mnz-mode)
#+end_src

Optionally depends on =language-detection= Emacs package.  If
=language-detection= is available, then laguage could be detected
automatically for code blocks without language explicitly
specified.  Install =language-detection= with @@html:<kbd>@@M-x package-install RET language-detection RET@@html:</kbd>@@

=telega-mnz= installs @@html:<kbd>@@'@@html:</kbd>@@
(~telega-mnz-send-region-as-code~) binding into
[[#telega-prefix-map][telega prefix map]] to attach region as code
to a chatbuf.

Also, =telega-mnz= installs ~code~ [[#attaching-media][media
attachment type]], use it with @@html:<kbd>@@C-c C-a code RET@@html:</kbd>@@ in
chatbuf.


Customizable options:
- User Option: ~telega-mnz-mode-for~ 

  Chat filter for ~global-telega-mnz-mode~.
  Global mnz mode enables ~telega-mnz-mode~ only for chats matching
  this chat filter. 

  Default value: ~all~

- User Option: ~telega-mnz-keep-pre-face~ 

  Non-nil to keep ~telega-entity-type-pre~ face on the highlighted text. 

  Default value: ~t~

- User Option: ~telega-mnz-edit-code-block~ 

  How to edit message containing mnz code blocks. 

  Default value: ~query~

- User Option: ~telega-mnz-use-language-detection~ 

  Non-nil to use ~language-detection~ for blocks without specified language.
  Could be also a number, meaning that language detection is done
  only for code larger then this number of chars. 

  Default value: ~50~

- User Option: ~telega-mnz-edit-display-buffer-action~ 

  Action value when poping to code edit buffer.
  See docstring for ~display-buffer~ for the value meaning. 

  Default value: ~((display-buffer-below-selected))~

** /telega-dashboard.el/ -- Important telega chats in the Emacs dashboard
:PROPERTIES:
:CUSTOM_ID: telega-dashboardel--important-telega-chats-in-the-emacs-dashboard
:END:

Display important telega chats in the Emacs dashboard.  Enable it with:

#+begin_src emacs-lisp
  (require 'telega-dashboard)
  (add-to-list 'dashboard-items '(telega-chats . 5))
#+end_src

Screenshot of =telega-dashboard= in action:
[[https://zevlg.github.io/telega/telega-dashboard.png]]

Customizable options:
- User Option: ~telega-dashboard-chat-filter~ 

  Chat Filter used to filter chats to display in the Emacs dashboard. 

  Default value: 
  #+begin_src emacs-lisp
    (or mention
        (and unread unmuted))
  #+end_src

- User Option: ~telega-dashboard-chat-inserter~ 

  Inserter for the chat button in the Emacs dashboard. 

  Default value: ~telega-ins--chat-full~

** /telega-stories.el/ -- Display Emacs Stories in the dashboard
:PROPERTIES:
:CUSTOM_ID: telega-storiesel--display-emacs-stories-in-the-dashboard
:END:

Emacs Stories: share your Emacs experience with other Emacs users.

Display recent [[https://t.me/emacs_stories][Emacs Stories]] in the
dashboard.  Enable it with:

#+begin_src emacs-lisp
  (require 'telega-stories)
  (telega-stories-mode 1)
  ;; "Emacs Stories" rootview
  (define-key telega-root-mode-map (kbd "v e") 'telega-view-emacs-stories)
  ;; Emacs Dashboard
  (add-to-list 'dashboard-items '(telega-stories . 5))
#+end_src

Apart from dashboard, ~telega-stories~ provides "Emacs Stories"
[[https://zevlg.github.io/telega.el/#rootbuf-view-switching][Root
View]].  To enable this view execute @@html:<kbd>@@M-x telega-view-emacs-stories RET@@html:</kbd>@@ in the root buffer.

If you see inappropriate content in some Emacs Story, please report
this story by pressing
@@html:<kbd>@@!@@html:</kbd>@@ (~telega-stories-msg-report~) on
the story.

For best performance consider newest Emacs28 with ~:base_uri~ svg
image property support.

Screenshots of =telega-stories= in action:
[[https://zevlg.github.io/telega/emacs-stories-dashboard.png]]

And screenshot of "Emacs Stories" rooot view:
[[https://zevlg.github.io/telega/emacs-stories-rootview.png]]

Customizable options:
- User Option: ~telega-stories-show~ 

  Show ~all~ or only ~unread~ stories. 

  Default value: ~unread~
- User Option: ~telega-stories-height~ 

  Height in chars for Emacs Stories buttons 

  Default value: ~6~
- User Option: ~telega-stories-notify-if~ 

  Pop notification on new story if stories chat matches this Chat Filter. 

  Default value: ~(not unmuted)~
- User Option: ~telega-stories-preload-content~ 

  Preload content when Emacs Story is inserted, so can be viewed instantly. 

  Default value: ~t~
- User Option: ~telega-stories-root-view-count~ 

  Number of Emacs Stories to show in "Emacs Stories" rootview. 

  Default value: ~12~
- User Option: ~telega-stories-root-view-keep-viewed~ 

  Keep viewed stories in the "Emacs Stories" rootview.
  Non-nil to keep story in the root view after story is viewed. 

  Default value: ~t~
